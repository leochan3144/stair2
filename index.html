<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å°æœ‹å‹ä¸‹æ¨“æ¢¯ - æ•¸å­¸æŒ‘æˆ°ç‰ˆ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.4/TweenMax.min.js"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background-color: black;
      font-family: Arial, sans-serif;
      touch-action: none; /* ç¦æ­¢æ‰‹æ©Ÿç€è¦½å™¨é è¨­çš„æ»‘å‹•è¡Œç‚º */
    }

    canvas {
      display: block;
      max-width: 100%;
      height: auto;
    }

    #startBtn {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      padding: 10px 70px;
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 500px;
      outline: none;
      font-size: 50px;
      letter-spacing: 1px;
      cursor: pointer;
      border: none;
      box-shadow: 0px 0px 20px rgba(255, 255, 255, 0.3);
      z-index: 10;
    }

    #startBtn:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    /* Leaderboard styles - é è¨­éš±è—ï¼ŒçµæŸæ™‚é¡¯ç¤º */
    #leaderboard {
      display: none; 
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 30px;
      border-radius: 15px;
      font-size: 16px;
      z-index: 25;
      min-width: 300px;
      box-shadow: 0 0 20px rgba(83, 211, 55, 0.5);
      border: 2px solid #53d337;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    #leaderboard h3 {
      margin: 0 0 20px 0;
      text-align: center;
      color: #ffdd38;
      font-size: 24px;
    }
    
    #leaderboard ol {
      padding-left: 20px;
      margin: 0;
    }
    
    #leaderboard li {
      margin-bottom: 8px;
      color: white;
      font-size: 18px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 5px 0;
    }
    
    .current-score {
      color: #53d337 !important;
      font-weight: bold;
    }

    #restartBtn {
        display: block;
        margin: 20px auto 0 auto;
        padding: 10px 30px;
        background-color: #53d337;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 20px;
        cursor: pointer;
    }
    
    /* Name input modal */
    #nameModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      z-index: 30;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: rgba(50, 50, 50, 0.95);
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
    }
    
    #nameInput {
      padding: 10px;
      font-size: 20px;
      border: 2px solid #53d337;
      border-radius: 5px;
      background-color: #222;
      color: white;
      margin: 15px 0;
      width: 250px;
      text-align: center;
    }
    
    #nameInput:focus {
      outline: none;
      border-color: #ffdd38;
    }
    
    #submitName {
      padding: 10px 30px;
      font-size: 20px;
      background-color: #53d337;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .modal-title {
      color: #ffdd38;
      font-size: 28px;
      margin-bottom: 20px;
    }
    
    .score-display {
      font-size: 24px;
      margin: 15px 0;
      color: white;
    }
    
    /* Touch controls */
    #touchControls {
      position: fixed;
      bottom: 30px;
      width: 100%;
      display: flex;
      justify-content: space-between; 
      padding: 0 40px;
      box-sizing: border-box;
      z-index: 20;
      pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°ç•«å¸ƒï¼Œé™¤éé»åˆ°æŒ‰éˆ• */
    }
    
    .touch-btn {
      pointer-events: auto; /* æ¢å¾©æŒ‰éˆ•çš„å¯é»æ“Šæ€§ */
      width: 100px;
      height: 100px;
      background-color: rgba(255, 255, 255, 0.15);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 40px;
      color: white;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: background-color 0.1s;
    }

    .touch-btn:active {
        background-color: rgba(255, 255, 255, 0.4);
    }
  </style>
</head>
<body>
  <canvas id="mycanvas"></canvas>
  <button id="startBtn" onclick="game.start()">Start</button>

  <div id="leaderboard">
    <h3>ğŸ† æ’è¡Œæ¦œ</h3>
    <ol id="scoresList"></ol>
    <button id="restartBtn" onclick="game.restartGame()">å†ç©ä¸€æ¬¡</button>
  </div>

  <div id="nameModal">
    <div class="modal-content">
      <div class="modal-title">æ–°ç´€éŒ„ï¼</div>
      <div class="score-display">åœ°ä¸‹ <span id="currentScoreDisplay" style="color:#53d337; font-weight:bold;">0</span> éš</div>
      <input type="text" id="nameInput" placeholder="è¼¸å…¥æ‚¨çš„åå­—" maxlength="10" autocomplete="off">
      <br>
      <button id="submitName">æäº¤æˆç¸¾</button>
    </div>
  </div>
  
  <div id="touchControls">
    <div class="touch-btn" id="leftBtn">â—€</div>
    <div class="touch-btn" id="rightBtn">â–¶</div>
  </div>

  <audio id="musicBg" src="sound/bgm.mp3" preload="auto"></audio>
  <audio id="transmiting" src="sound/transmit.mp.mp3" preload="auto"></audio>
  <audio id="hurt" src="sound/hurt.mp3" preload="auto"></audio>
  <audio id="fade" src="sound/fade.mp3" preload="auto"></audio>
  <audio id="dead" src="sound/help.mp3" preload="auto"></audio>
  <audio id="step" src="sound/step.mp3" preload="auto"></audio>
  <audio id="jump" src="sound/jump.mp3" preload="auto"></audio>
  <audio id="correct" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" preload="auto"></audio> <script>
    //ç’°å¢ƒè®Šæ•¸
    var updateFPS = 30
    var showMouse = true
    var time = 0
    var bgColor ="black"

    //æ§åˆ¶
    var controls = {
      value: 0
    }
    var gui = new dat.GUI()
    gui.add(controls,"value",-2,2).step(0.01).onChange(function(value){})
    gui.close(); // é è¨­é—œé–‰ GUI ä»¥å…æ“‹ä½

    var bgm = document.getElementById('musicBg');
    bgm.volume = 0.4;
    document.getElementById('transmiting').volume=0.3
    document.getElementById('step').volume=0.7
    bgm.addEventListener('ended', function(){
      this.currentTime = 0;
      this.play();
    }, false);

    //------------------------
    // Vec2
    class Vec2{
      constructor(x,y){
        this.x = x
        this.y = y
      }
      set(x,y){
        this.x =x
        this.y =y
      }
      move(x,y){
        this.x+=x
        this.y+=y
      }
      add(v){
        return new Vec2(this.x+v.x,this.y+v.y)
      }
      sub(v){
        return new Vec2(this.x-v.x,this.y-v.y)
      }
      mul(s){
        return new Vec2(this.x*s,this.y*s)
      }
      get length(){
        return Math.sqrt(this.x*this.x+this.y*this.y)
      }
      set length(nv){
        let temp = this.unit.mul(nv)
        this.set(temp.x,temp.y)
      }
      clone(){
        return new Vec2(this.x,this.y)
      }
      toString(){
        return `(${this.x}, ${this.y})`
      }
      equal(v){
        return this.x==v.x && this.y ==v.y
      }
      get angle(){
        return Math.atan2(this.y,this.x)  
      }
      get unit(){
        return this.mul(1/this.length)
      }
      
    }

    //------
    var canvas = document.getElementById("mycanvas")
    var ctx = canvas.getContext("2d")
    ctx.circle= function(v,r){
      this.arc(v.x,v.y,r,0,Math.PI*2)
    }
    ctx.line= function(v1,v2){
      this.moveTo(v1.x,v1.y)
      this.lineTo(v2.x,v2.y)
    }

    function playSound(id){
      var sound = document.getElementById(id);
      sound.currentTime=0
      sound.play().catch(e => console.log(e)); // æ•æ‰éŒ¯èª¤ä»¥å…å½±éŸ¿éŠæˆ²
    }

    //æ’è¡Œæ¦œç›¸é—œå‡½æ•¸
    function getLeaderboard() {
      const saved = localStorage.getItem('stairGameLeaderboard_math'); // ä½¿ç”¨æ–°çš„ key é¿å…è¡çª
      return saved ? JSON.parse(saved) : [];
    }

    function saveLeaderboard(scores) {
      localStorage.setItem('stairGameLeaderboard_math', JSON.stringify(scores));
    }

    function updateLeaderboardDisplay() {
      const scores = getLeaderboard();
      const scoresList = document.getElementById('scoresList');
      scoresList.innerHTML = '';
      
      scores.slice(0, 10).forEach((entry, index) => {
        const li = document.createElement('li');
        li.textContent = `${entry.name}: ${entry.score}éš`;
        if (entry.isCurrent) {
          li.classList.add('current-score');
        }
        scoresList.appendChild(li);
      });
    }

    function checkNewRecord(score) {
      const scores = getLeaderboard();
      // å¦‚æœåˆ†æ•¸å¤ªä½é€£æ¦œéƒ½æ²’ä¸Šï¼Œç›´æ¥é¡¯ç¤ºæ’è¡Œæ¦œ
      if (scores.length >= 10 && score <= scores[9].score) {
        document.getElementById('leaderboard').style.display = 'block';
        updateLeaderboardDisplay();
        return;
      }

      // æœ‰æ©Ÿæœƒä¸Šæ¦œï¼Œé¡¯ç¤ºè¼¸å…¥æ¡†
      document.getElementById('currentScoreDisplay').textContent = score;
      document.getElementById('nameModal').style.display = 'flex';
      setTimeout(()=> document.getElementById('nameInput').focus(), 100);
    }

    function submitName() {
      const name = document.getElementById('nameInput').value.trim() || 'ç„¡åè‹±é›„';
      const score = parseInt(document.getElementById('currentScoreDisplay').textContent);
      
      const scores = getLeaderboard();
      const newEntry = { score: score, name: name, isCurrent: true };
      
      // ç§»é™¤èˆŠçš„ current æ¨™è¨˜
      scores.forEach(s => s.isCurrent = false);
      
      scores.push(newEntry);
      scores.sort((a, b) => b.score - a.score); // é™åºæ’åˆ—
      
      // åªä¿ç•™å‰ 10 å
      const top10 = scores.slice(0, 10);
      
      saveLeaderboard(top10);
      
      document.getElementById('nameModal').style.display = 'none';
      document.getElementById('leaderboard').style.display = 'block';
      updateLeaderboardDisplay();
    }

    //éŠæˆ²ç‰©ä»¶
    class Game{
      constructor(){
        this.player = null
        this.walls = []
        this.width = 700
        this.height = wh
        this.walltypes = [
          "normal","jump","slideLeft","slideRight",
          "hurt","fade"
        ]
        this.hurt=0
        this.playing=false
        this.keystatus = {
          left: false,
          right: false,
          up: false,
          down: false,
        }
        this.time=0
        
        // æ•¸å­¸ç›¸é—œå±¬æ€§
        this.mathQuestion = "";
        this.correctAnswer = 0;
        this.wrongAnswer = 0;
      }
      
      // ç”Ÿæˆæ–°çš„æ•¸å­¸é¡Œç›®
      generateMathProblem() {
        // éš¨æ©Ÿæ±ºå®šåŠ æ³•æˆ–æ¸›æ³•
        const isAddition = Math.random() > 0.5;
        let n1, n2;
        
        if (isAddition) {
            n1 = Math.floor(Math.random() * 20) + 1; // 1-20
            n2 = Math.floor(Math.random() * 20) + 1;
            this.correctAnswer = n1 + n2;
            this.mathQuestion = `${n1} + ${n2} = ?`;
        } else {
            // æ¸›æ³•ç¢ºä¿çµæœæ˜¯æ­£æ•¸
            n1 = Math.floor(Math.random() * 20) + 5;
            n2 = Math.floor(Math.random() * n1); // ç¢ºä¿ n2 < n1
            this.correctAnswer = n1 - n2;
            this.mathQuestion = `${n1} - ${n2} = ?`;
        }
        
        // ç”ŸæˆéŒ¯èª¤ç­”æ¡ˆ (ç¢ºä¿ä¸ç­‰æ–¼æ­£ç¢ºç­”æ¡ˆ)
        do {
            let offset = Math.floor(Math.random() * 5) + 1; // 1-5 èª¤å·®
            if (Math.random() > 0.5) offset *= -1;
            this.wrongAnswer = this.correctAnswer + offset;
        } while (this.wrongAnswer < 0 || this.wrongAnswer === this.correctAnswer);
        
        // console.log("New Math:", this.mathQuestion, "Ans:", this.correctAnswer, "Wrong:", this.wrongAnswer);
      }

      init(){
        // åˆå§‹åŒ–
        this.walls=[]
        this.generateMathProblem(); // éŠæˆ²é–‹å§‹å…ˆå‡ºä¸€é¡Œ
        
        for(var i=0;i<wh/150;i++){
          this.walls.push(new Wall({
            p: new Vec2(Math.random()*this.width, i*150+100),
            type: "normal" // åˆå§‹åœ°æ¿å®‰å…¨ä¸€é»
          })) 
        }
        this.player = new Player({
          p: new Vec2(ww/2,200)
        })    
      }
      
      start(){
        document.getElementById('musicBg').play().catch(e=>console.log("Audio play failed"));
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('leaderboard').style.display = 'none';
        this.init()
        this.playing=true
        this.time=0
      }
      
      restartGame() {
        document.getElementById('leaderboard').style.display = 'none';
        this.start();
      }

      end(){
        document.getElementById('startBtn').style.display = 'none'; // éš±è—é–‹å§‹æŒ‰éˆ•ï¼Œæ”¹ç”¨æ’è¡Œæ¦œçš„é‡ä¾†
        playSound('dead');  
        this.playing=false
        
        // æª¢æŸ¥æ’è¡Œæ¦œ
        const finalScore = parseInt(this.time/100);
        checkNewRecord(finalScore);
      }
      
      update(){
        this.time++
        //æ›´æ–°ç©å®¶è·Ÿå·¦å³èµ°
        this.player.update()
        if (this.keystatus.left){
          this.player.p.x-=8
        }
        if (this.keystatus.right){
          this.player.p.x+=8
        }
        
        //æ¨å…¥æ–°çš„åœ°æ¿
        if (time%20==0){
          let newType = this.walltypes[parseInt(Math.random()*this.walltypes.length)];
          let newWall = new Wall({
            p: new Vec2(Math.random()*this.width, this.height),
            type: newType
          });
          
          // ç‚ºæ™®é€šæˆ–è·³èºåœ°æ¿éš¨æ©Ÿåˆ†é…ç­”æ¡ˆ
          if (newType === "normal" || newType === "jump") {
            const roll = Math.random();
            if (roll < 0.3) {
                // 30% æ©Ÿç‡æ˜¯æ­£ç¢ºç­”æ¡ˆ
                newWall.number = this.correctAnswer;
            } else if (roll < 0.6) {
                // 30% æ©Ÿç‡æ˜¯éŒ¯èª¤ç­”æ¡ˆ
                newWall.number = this.wrongAnswer;
            }
            // 40% æ©Ÿç‡æ²’æœ‰æ•¸å­—
          }
          
          this.walls.push(newWall);
        }
        
        let touching = false
        //è™•ç†åœ°æ¿è·Ÿäººçš„ç¢°æ’
        this.walls.forEach(wall=>{  
          wall.update() 
          if (wall.p.x-wall.width/2<this.player.p.x+this.player.width/2
              &&   wall.p.x+wall.width/2>this.player.p.x-this.player.width/2){
            if (this.player.p.y>wall.p.y 
                && this.player.p.y<wall.p.y+wall.height+10){ 
              touching=true
              wall.step(this.player)
              this.player.lastBlock=wall
            }
          }
        }) 
        
        //å¦‚æœæ²’æœ‰ä»»ä½•æ¥è§¸ï¼Œæ¸…æ‰ä¸Šä¸€å€‹æ¥è§¸çš„ç´€éŒ„
        if (!touching){
          this.player.lastBlock=null
          document.getElementById("transmiting").pause()
        }

        this.walls = this.walls.filter(wall=>wall.active)
        
        //è¢«ä¸Šé¢åˆºåˆ°
        if (this.player.p.y-this.player.height<0){
          if (this.hurt==0){   
            this.hurt=1
            this.player.bloodDelta(-1)
            this.player.v.y=2
            this.player.p.y=10
            TweenMax.to(this,0.5,{hurt: 0})
          }
        }
        
        //å·¦å³é™åˆ¶
        if (this.player.p.x-this.player.width/2<0){
          this.player.p.x=this.player.width/2
        }
        if (this.player.p.x+this.player.width/2>this.width){
          this.player.p.x=this.width-this.player.width/2
        }
        
        //æ‰åˆ°æ‡¸å´–
        if (this.player.p.y>wh+this.player.height){
          game.end()
        }
      }
      
      draw(){
        ctx.save()
          //ç§»å‹•åº§æ¨™åˆ°éŠæˆ²å·¦é‚Šç•Œ
          ctx.translate(ww/2-this.width/2,0)
          let span = this.width/60
          ctx.beginPath()
          for(var i=0;i<=this.width/span;i++){
            ctx.lineTo(i*span,(i%2)*30)
          }  
          ctx.fillStyle="white"
          ctx.fill()
        
          //ç¹ªè£½ç•Œç·š
          ctx.beginPath()
          ctx.moveTo(0,0)
          ctx.lineTo(0,wh)
          ctx.moveTo(this.width,0)
          ctx.lineTo(this.width,wh)
          ctx.strokeStyle="rgba(255,255,255,0.3)"
          ctx.stroke()
        
          this.player.draw()
          this.walls.forEach(wall=>wall.draw())
        ctx.restore()
        
        //ç–¼ç—›çš„è¡€å¹•
        ctx.fillStyle="rgba(255,0,0,"+this.hurt+")"
        ctx.fillRect(0,0,ww,wh)
        
        //ç¹ªè£½è¡€é‡
        this.player.drawBlood()
        
        //ç¹ªè£½éšæ•¸
        ctx.fillStyle='white'
        ctx.font="50px Arial"
        ctx.fillText( "åœ°ä¸‹ï¼š"+(parseInt(this.time/100))+"éš",40,100)
        
        //ç¹ªè£½æ•¸å­¸é¡Œç›®
        ctx.fillStyle='#ffdd38'
        ctx.font="bold 40px Arial"
        ctx.fillText("é¡Œç›®: " + this.mathQuestion, 40, 160)
        
        ctx.font="10px Arial"
      }
    }

    //ç©å®¶ç‰©ä»¶
    class Player{
      constructor(args){
        let def = {
          p: new Vec2(0,0),
          v: new Vec2(0,0),
          a: new Vec2(0,1), 
          width: 40,
          height: 55,
          blood: 10,
          maxBlood: 10,
          lastBlock: null,
        }
        Object.assign(def,args)
        Object.assign(this,def)
      }
      update(){
        this.p=this.p.add(this.v)
        this.v=this.v.add(this.a)
        
      }
      draw(){
        //ç•«å‡ºäººå½¢ç‹€
        ctx.beginPath()
        
        ctx.save()
          ctx.translate(this.p.x,this.p.y)
          ctx.fillStyle="#0047ba"
          ctx.fillRect(-this.width/2,-this.height,this.width,this.height)
          ctx.fillStyle="#ffdd38"

          ctx.fillRect(-5,-30,10,10)

          //å·¦å³çœ¼
          ctx.beginPath()
          ctx.arc(-6,-40,5,0,Math.PI*2)
          ctx.arc(+6,-40,5,0,Math.PI*2)
          ctx.fillStyle="white"
          ctx.fill()

          //ç³å­”
          ctx.beginPath()
          ctx.arc(-6,-40,3,0,Math.PI*2)
          ctx.arc(+6,-40,3,0,Math.PI*2)
          ctx.fillStyle="black"   
          ctx.fill()
        
        //å³æ‰‹
        ctx.save()
            ctx.translate(+this.width/2,-40)
            ctx.rotate(-Math.log(this.v.y/2))
            ctx.fillStyle="#416ee0"
            ctx.fillRect(0,0,8,this.height/2 )

          ctx.restore()

          //å·¦æ‰‹
          ctx.save()
            ctx.translate(-this.width/2,-40)
            ctx.rotate(Math.log(this.v.y/2))
            ctx.fillStyle="#416ee0"
            ctx.fillRect(-8,0,8,this.height/2 )

          ctx.restore()

        ctx.restore()
      }
      //ç•«å‡ºè¡€é‡
      drawBlood(){
        for(var i=0;i<10;i++){
          ctx.fillStyle=i<this.blood?"red":"rgba(255,255,255,0.2)"
          ctx.fillRect(30+i*15+(i-1)*4,30,10,30)
        }
      }
      //æ‰£è¡€é‡çš„çµ±ä¸€ç®¡ç†
      bloodDelta(delta){
        if (delta<0){
          playSound('hurt')
        }
        this.blood+=delta
        if (this.blood>this.maxBlood){
          this.blood=this.maxBlood
        }
        if (this.blood<=0){
          
          
          this.blood=0
          game.end()
        }
      }
    }

    //-----------------
    //      ç‰†å£ç‰©ä»¶
    //-----------------
    class Wall{
      constructor(args){
        let def = {
          p: new Vec2(0,0),
          v: new Vec2(0,-4),
          a: new Vec2(0,0),
          width: 150,
          height: 20, 
          extraHeight: 0,
          type: "normal",
          active: true,
          number: null // ç‰†å£ä¸Šçš„æ•¸å­— (æ­£ç¢ºæˆ–éŒ¯èª¤ç­”æ¡ˆ)
        }
        Object.assign(def,args)
        Object.assign(this,def)
      }
      update(){
        this.p=this.p.add(this.v)
        this.v=this.v.add(this.a)
        if (this.p.y<-20){
          this.active=false
        }
      }
      
      draw(){
        ctx.save()
        //ç§»å‹•åˆ°ç‰†å£ä½ç½®
        ctx.translate(this.p.x-this.width/2,this.p.y-this.extraHeight)
          ctx.fillStyle="white"
          ctx.font = "12px Arial"
        //   ctx.fillText(this.type,0,30)
          
          if (this.type=="normal" || this.type=="hurt"){
            
            ctx.fillStyle="#888" 
            ctx.fillRect(0,0,this.width,this.height/2)
          }
        
          //å—å‚·
          if (this.type=="hurt"){
            ctx.beginPath()
            let span = this.width/16
            for(var i=0;i<=this.width/span;i+=1){ 
              ctx.lineTo(0+i*span,-(i%2)*15)
            }
            ctx.fillStyle="#ddd" 
            ctx.fill()
          }
        
          //è·³è·³æ¿
          if (this.type=="jump"){
            ctx.fillStyle="#53d337"
            ctx.fillRect(0,0,this.width,5)
            ctx.fillRect(0,this.height+this.extraHeight,this.width,5)
            
          }
          //ç©¿é€
          if (this.type=="fade"){
            ctx.fillStyle="#ffd428"
            ctx.fillRect(0,0,this.width,this.height)
            
          }
          //  å·¦æ»‘è·Ÿå³æ»‘
          if (this.type=="slideLeft" || this.type=="slideRight"){
            for(var i=-1;i<this.width/20;i+=1){ 
              let x = 0+i*20+(time%20)* (this.type=="slideLeft"?-1:1)
              let width = 10
              if (x<0){
                x=0
              } 
              if (x+width>this.width){
                width = this.width-x<0?0:(this.width-x)
              }
              ctx.fillStyle="red"
              ctx.save()
              //å‚¾æ–œ
              ctx.transform(1, 0,0.5, 1, 0, 0)
              ctx.fillRect(x ,0,width,this.height)
              ctx.restore()
            }
          }
          
          // ç¹ªè£½æ•¸å­— (å¦‚æœæœ‰)
          if (this.number !== null) {
              ctx.fillStyle = "white";
              ctx.font = "bold 30px Arial";
              ctx.textAlign = "center";
              // å­—é«”é™°å½±ï¼Œè®“å®ƒåœ¨æ·ºè‰²åœ°æ¿ä¹Ÿçœ‹å¾—åˆ°
              ctx.shadowColor="black";
              ctx.shadowBlur=4;
              ctx.fillText(this.number, this.width/2, -10);
              ctx.shadowBlur=0;
          }
          
        ctx.restore()
      } 
      //ä¸åŒåœ°æ¿è¸©åˆ°æ™‚çš„å½±éŸ¿
      step(player){
        player.v.y=0
        if (player.lastBlock!=this){
          
          // --- æ•¸å­¸é‚è¼¯åˆ¤æ–· ---
          if (this.number !== null) {
              if (this.number === game.correctAnswer) {
                  // ç­”å°äº†
                  playSound('correct'); // å¯é¸ï¼šå¢åŠ æ­£ç¢ºéŸ³æ•ˆ
                  player.bloodDelta(1);
                  // ç­”å°å¾Œç”Ÿæˆæ–°é¡Œç›®
                  game.generateMathProblem();
              } else {
                  // ç­”éŒ¯äº†
                  // playSound('wrong'); 
                  player.bloodDelta(-1);
              }
              // åƒæ‰æ•¸å­—ï¼Œé¿å…é‡è¤‡è§¸ç™¼
              this.number = null;
          }
          // --- çµæŸæ•¸å­¸é‚è¼¯ ---

          // æ³¨æ„ï¼šå·²ç§»é™¤åŸæœ¬çš„ player.bloodDelta(1) ä¾†å–æ¶ˆè‘—åœ°å›è¡€
          
          if (this.type=="normal"){
            playSound('step')
          }
          if (this.type=="fade"){
            playSound('fade')
          }
          if (this.type=="hurt"){
            playSound('hurt')
          }
          if (this.type=="jump"){
            playSound('jump')
          }
        }
        if (this.type=="normal"){
          player.p.y = this.p.y
        }
        if (this.type=="hurt"){
          player.p.y = this.p.y
          
          if (player.lastBlock!=this){
            player.bloodDelta(-2) 
            game.hurt=1
            TweenMax.to( game,0.2,{hurt: 0} )
          }
        }
        if (this.type=="jump"){
          player.v.y = -15
          this.extraHeight=10
          TweenMax.to(this,0.2,{extraHeight: 0})
        } 
        if (this.type=="slideLeft"){ 
          player.p.x-=3
          player.p.y = this.p.y
             document.getElementById("transmiting").play()
        }
        if (this.type=="slideRight"){
          player.p.x+=3
          player.p.y = this.p.y
             document.getElementById("transmiting").play()
        }
        if (this.type=="fade"){
          player.p.y-=3
          // player.p.y = this.p.y
        }
      }
      
    }

    function initCanvas(){
      ww = canvas.width = window.innerWidth
      wh = canvas.height = window.innerHeight
    }
    initCanvas()

    var game = new Game

    function init(){
      game.init()
    }
    function update(){
      time++
      if (game.playing){
        game.update()
      }
    }
    function draw(){
       //æ¸…ç©ºèƒŒæ™¯
      ctx.fillStyle=bgColor
      ctx.fillRect(0,0,ww,wh)
      
      //-------------------------
      //   åœ¨é€™è£¡ç¹ªè£½
      
      game.draw()
      
      //-----------------------
      //ç¹ªè£½æ»‘é¼ åº§æ¨™
      
    //   ctx.fillStyle="red"
    //   ctx.beginPath()
    //   ctx.circle(mousePos,2)
    //   ctx.fill()
        
    //   ctx.save()
    //   ctx.beginPath()
    //   ctx.translate(mousePos.x,mousePos.y)
    //     ctx.strokeStyle="red"
    //     let len = 20
    //     ctx.line(new Vec2(-len,0),new Vec2(len,0))
    //     ctx.line(new Vec2(0,-len),new Vec2(0,len))
    //     ctx.fillText(mousePos,10,-10)
    //     ctx.stroke()
    //   ctx.restore()
      
      //schedule next render

      requestAnimationFrame(draw)
    }
    function loaded(){
      initCanvas()
      init()
      requestAnimationFrame(draw)
      setInterval(update,1000/updateFPS)
    }
    window.addEventListener("load",loaded)
    window.addEventListener("resize",initCanvas)

    //æ»‘é¼ äº‹ä»¶è·Ÿç´€éŒ„
    var mousePos = new Vec2(0,0)
    var mousePosDown = new Vec2(0,0)
    var mousePosUp = new Vec2(0,0)

    window.addEventListener("mousemove",mousemove)
    window.addEventListener("mouseup",mouseup)
    window.addEventListener("mousedown",mousedown)
    function mousemove(evt){
      mousePos.set(evt.clientX,evt.clientY)
    }
    function mouseup(evt){
      mousePos.set(evt.clientX,evt.clientY)
      mousePosUp = mousePos.clone()
      
    }
    function mousedown(evt){
      mousePos.set(evt.clientX,evt.clientY)
      mousePosDown = mousePos.clone()
    }

    // keystatus= {}
    window.addEventListener('keydown',function(evt){
      let key = evt.key.replace("Arrow","").toLowerCase()
      game.keystatus[key]=true
    })

    window.addEventListener('keyup',function(evt){
      let key = evt.key.replace("Arrow","").toLowerCase()
      game.keystatus[key]=false
    })

    // Touch controls for mobile/iPad
    const leftBtn = document.getElementById('leftBtn');
    const rightBtn = document.getElementById('rightBtn');
    
    // ä½¿ç”¨ touchstart å’Œ touchend ä¾†æ¨¡æ“¬æŒ‰éµæŒ‰ä¸‹å’Œæ”¾é–‹
    const handleTouchStart = (direction) => (e) => {
        e.preventDefault(); // é˜²æ­¢é•·æŒ‰é¸å–æ–‡å­—æˆ–è·³å‡ºé¸å–®
        game.keystatus[direction] = true;
        e.target.style.backgroundColor = "rgba(255, 255, 255, 0.4)";
    };

    const handleTouchEnd = (direction) => (e) => {
        e.preventDefault();
        game.keystatus[direction] = false;
        e.target.style.backgroundColor = "rgba(255, 255, 255, 0.15)";
    };
    
    leftBtn.addEventListener('touchstart', handleTouchStart('left'), {passive: false});
    leftBtn.addEventListener('touchend', handleTouchEnd('left'), {passive: false});
    
    rightBtn.addEventListener('touchstart', handleTouchStart('right'), {passive: false});
    rightBtn.addEventListener('touchend', handleTouchEnd('right'), {passive: false});

    // åå­—è¼¸å…¥æ¡†çš„äº‹ä»¶
    document.getElementById('submitName').addEventListener('click', submitName);
    document.getElementById('nameInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        submitName();
      }
    });
  </script>
</body>
</html>
